function AtDCore(){this.ignore_types=["Bias Language","Cliches","Complex Expression","Diacritical Marks","Double Negatives","Hidden Verbs","Jargon Language","Passive voice","Phrases to Avoid","Redundant Expression"],this.ignore_strings={},this.i18n={}}function TokenIterator(a){this.tokens=a,this.index=0,this.count=0,this.last=0}function atd_sprintf(a,b){for(var c=a,d=0;d<b.length;d++)c=c.replace(new RegExp("%"+(d+1)+"\\$","g"),b[d]);return c}var EXPORTED_SYMBOLS=["AtDCore"];AtDCore.prototype.getLang=function(a,b){return window.AtD_l10n_r0ar&&window.AtD_l10n_r0ar[a]||b},AtDCore.prototype.addI18n=function(a){window.AtD_l10n_r0ar=a},AtDCore.prototype.setIgnoreStrings=function(a){var b=this;this.map(a.split(/,\s*/g),function(a){b.ignore_strings[a]=1})},AtDCore.prototype.showTypes=function(a){var b=a.split(/,\s*/g),c={};c["Double Negatives"]=1,c["Hidden Verbs"]=1,c["Passive voice"]=1,c["Bias Language"]=1,c.Cliches=1,c["Complex Expression"]=1,c["Diacritical Marks"]=1,c["Jargon Language"]=1,c["Phrases to Avoid"]=1,c["Redundant Expression"]=1;var d=[];this.map(b,function(a){c[a]=void 0}),this.map(this.ignore_types,function(a){void 0!==c[a]&&d.push(a)}),this.ignore_types=d},AtDCore.prototype.makeError=function(a,b,c,d){var e={};return e.type=c,e.string=a,e.tokens=b,e.regexp=new RegExp(new RegExp("\\b"+a+"\\b").test(a)?"(?!"+a+"<)\\b"+a.replace(/\s+/g,d)+"\\b":new RegExp(a+"\\b").test(a)?"(?!"+a+"<)"+a.replace(/\s+/g,d)+"\\b":new RegExp("\\b"+a).test(a)?"(?!"+a+"<)\\b"+a.replace(/\s+/g,d):"(?!"+a+"<)"+a.replace(/\s+/g,d)),e.used=!1,e},AtDCore.prototype.addToErrorStructure=function(a,b,c,d){var e=this;this.map(b,function(b){var f=b.word.split(/\s+/),g=b.pre,h=f[0];void 0===a["__"+h]&&(a["__"+h]={},a["__"+h].pretoks={},a["__"+h].defaults=[]),""===g?a["__"+h].defaults.push(e.makeError(b.word,f,c,d,g)):(void 0===a["__"+h].pretoks["__"+g]&&(a["__"+h].pretoks["__"+g]=[]),a["__"+h].pretoks["__"+g].push(e.makeError(b.word,f,c,d,g)))})},AtDCore.prototype.buildErrorStructure=function(a,b,c){var d=this._getSeparators(),e={};return this.addToErrorStructure(e,a,"hiddenSpellError",d),this.addToErrorStructure(e,c,"hiddenGrammarError",d),this.addToErrorStructure(e,b,"hiddenSuggestion",d),e},AtDCore.prototype._getSeparators=function(){var a,b="",c='"s!#$%&()*+,./:;<=>?@[\\]^_{|}';for(a=0;a<c.length;a++)b+="\\"+c.charAt(a);return"(?:(?:[ "+b+"])|(?:\\-\\-))+"},AtDCore.prototype.processXML=function(a){var b={};this.map(this.ignore_types,function(a){b[a]=1}),this.suggestions=[];for(var c=a.getElementsByTagName("error"),d=[],e=[],f=[],g=0;g<c.length;g++)if(null!==c[g].getElementsByTagName("string").item(0).firstChild){var h,i=c[g].getElementsByTagName("string").item(0).firstChild.data,j=c[g].getElementsByTagName("type").item(0).firstChild.data,k=c[g].getElementsByTagName("description").item(0).firstChild.data;if(h=null!==c[g].getElementsByTagName("precontext").item(0).firstChild?c[g].getElementsByTagName("precontext").item(0).firstChild.data:"",void 0===this.ignore_strings[i]){var l={};if(l.description=k,l.suggestions=[],l.matcher=new RegExp("^"+i.replace(/\s+/,this._getSeparators())+"$"),l.context=h,l.string=i,l.type=j,this.suggestions.push(l),null!==c[g].getElementsByTagName("suggestions").item(0))for(var m=c[g].getElementsByTagName("suggestions").item(0).getElementsByTagName("option"),n=0;n<m.length;n++)l.suggestions.push(m[n].firstChild.data);if(null!==c[g].getElementsByTagName("url").item(0)){var o=c[g].getElementsByTagName("url").item(0).firstChild.data;l.moreinfo=o+"&theme=tinymce"}void 0===b[k]&&("suggestion"===j&&f.push({word:i,pre:h}),"grammar"===j&&d.push({word:i,pre:h})),("spelling"===j||"Homophone"===k)&&e.push({word:i,pre:h}),"Cliches"===k&&(l.description="Clichés"),"Spelling"===k&&(l.description=this.getLang("menu_title_spelling","Spelling")),"Repeated Word"===k&&(l.description=this.getLang("menu_title_repeated_word","Repeated Word")),"Did you mean..."===k&&(l.description=this.getLang("menu_title_confused_word","Did you mean..."))}}var p,q=e.length+d.length+f.length;return p=q>0?this.buildErrorStructure(e,f,d):void 0,{errors:p,count:q,suggestions:this.suggestions}},AtDCore.prototype.findSuggestion=function(a){var b=a.innerHTML,c=(this.getAttrib(a,"pre")+"").replace(/[\\,!\\?\\."\s]/g,"");void 0===this.getAttrib(a,"pre")&&alert(a.innerHTML);for(var d,e=this.suggestions.length,f=0;e>f;f++)if((""===c||c===this.suggestions[f].context)&&this.suggestions[f].matcher.test(b)){d=this.suggestions[f];break}return d},TokenIterator.prototype.next=function(){var a=this.tokens[this.index];return this.count=this.last,this.last+=a.length+1,this.index++,""!==a&&("'"===a[0]&&(a=a.substring(1,a.length)),"'"===a[a.length-1]&&(a=a.substring(0,a.length-1))),a},TokenIterator.prototype.hasNext=function(){return this.index<this.tokens.length},TokenIterator.prototype.hasNextN=function(a){return this.index+a<this.tokens.length},TokenIterator.prototype.skip=function(a,b){this.index+=a,this.last+=b,this.index<this.tokens.length&&(this.count=this.last-this.tokens[this.index].length)},TokenIterator.prototype.getCount=function(){return this.count},TokenIterator.prototype.peek=function(a){for(var b=[],c=this.index+a,d=this.index;c>d;d++)b.push(this.tokens[d]);return b},AtDCore.prototype.markMyWords=function(a,b){var c=new RegExp(this._getSeparators()),d=[],e=0,f=this,g=this._isTinyMCE?' data-mce-bogus="1"':"",h='<span class="mceItemHidden"'+g+">&nbsp;</span>";this._walk(a,function(a){3!==a.nodeType||f.isMarkedNode(a)||d.push(a)});var i;return this.map(d,function(a){var d;if(3===a.nodeType){d=a.nodeValue;var j=a.nodeValue.split(c),k="",l=[];for(i=new TokenIterator(j);i.hasNext();){var m,n=i.next(),o=b["__"+n];if(void 0!==o&&void 0!==o.pretoks){m=o.defaults,o=o.pretoks["__"+k];var p,q,r=!1;p=d.substr(0,i.getCount()),q=d.substr(p.length,d.length);var s=function(a){void 0!==a&&!a.used&&void 0===t["__"+a.string]&&a.regexp.test(q)&&(t["__"+a.string]=1,l.push([a.regexp,'<span class="'+a.type+'" pre="'+k+'"'+g+">$&</span>"]),a.used=!0,r=!0)},t={};void 0!==o&&(k+=" ",f.map(o,s)),r||(k="",f.map(m,s))}k=n}if(l.length>0){for(var u=a,v=0;v<l.length;v++){var w=l[v][0],x=l[v][1],y=function(a){if(3===a.nodeType)return e++,f.isIE()&&a.nodeValue.length>0&&" "===a.nodeValue.substr(0,1)?f.create(h+a.nodeValue.substr(1,a.nodeValue.length-1).replace(w,x),!1):f.create(a.nodeValue.replace(w,x),!1);for(var b=f.contents(a),c=0;c<b.length;c++)if(3===b[c].nodeType&&w.test(b[c].nodeValue)){var d;return d=f.isIE()&&b[c].nodeValue.length>0&&" "===b[c].nodeValue.substr(0,1)?f.create(h+b[c].nodeValue.substr(1,b[c].nodeValue.length-1).replace(w,x),!0):f.create(b[c].nodeValue.replace(w,x),!0),f.replaceWith(b[c],d),f.removeParent(d),e++,a}return a};u=y(u)}f.replaceWith(a,u)}}}),e},AtDCore.prototype._walk=function(a,b){var c;for(c=0;c<a.length;c++)b.call(b,a[c]),this._walk(this.contents(a[c]),b)},AtDCore.prototype.removeWords=function(a,b){var c=0,d=this;return this.map(this.findSpans(a).reverse(),function(a){if(a&&(d.isMarkedNode(a)||d.hasClass(a,"mceItemHidden")||d.isEmptySpan(a)))if("&nbsp;"===a.innerHTML){var e=document.createTextNode(" ");d.replaceWith(a,e)}else b&&a.innerHTML!==b||(d.removeParent(a),c++)}),c},AtDCore.prototype.isEmptySpan=function(a){return""===this.getAttrib(a,"class")&&""===this.getAttrib(a,"style")&&""===this.getAttrib(a,"id")&&!this.hasClass(a,"Apple-style-span")&&""===this.getAttrib(a,"mce_name")},AtDCore.prototype.isMarkedNode=function(a){return this.hasClass(a,"hiddenGrammarError")||this.hasClass(a,"hiddenSpellError")||this.hasClass(a,"hiddenSuggestion")},AtDCore.prototype.applySuggestion=function(a,b){if("(omit)"===b)this.remove(a);else{var c=this.create(b);this.replaceWith(a,c),this.removeParent(c)}},AtDCore.prototype.hasErrorMessage=function(a){return void 0!==a&&null!==a.getElementsByTagName("message").item(0)},AtDCore.prototype.getErrorMessage=function(a){return a.getElementsByTagName("message").item(0)},AtDCore.prototype.isIE=function(){return"Microsoft Internet Explorer"===navigator.appName};