!function(){function a(a,b){return window.AtD_l10n_r0ar&&window.AtD_l10n_r0ar[a]||b}var b,c=tinymce.each,d=tinymce.DOM;tinymce.create("tinymce.plugins.AfterTheDeadlinePlugin",{getInfo:function(){return{longname:"After The Deadline",author:"Raphael Mudge",authorurl:"http://blog.afterthedeadline.com",infourl:"http://www.afterthedeadline.com",version:tinymce.majorVersion+"."+tinymce.minorVersion}},initAtDCore:function(a){var b=new AtDCore;return b.map=c,b.getAttrib=function(b,c){return a.dom.getAttrib(b,c)},b.findSpans=function(b){return b?a.dom.select("span",b):a.dom.select("span")},b.hasClass=function(b,c){return a.dom.hasClass(b,c)},b.contents=function(a){return a.childNodes},b.replaceWith=function(b,c){return a.dom.replace(c,b)},b.create=function(b){return a.dom.create("span",{"class":"mceItemHidden"},b)},b.removeParent=function(b){return a.dom.remove(b,1),b},b.remove=function(b){a.dom.remove(b)},b.setIgnoreStrings(a.getParam("atd_ignore_strings",[]).join(",")),b.showTypes(a.getParam("atd_show_types","")),b},init:function(d,e){if("undefined"!=typeof AtDCore){var f=this,g=d;this.url=e,this.editor=d,b=d.core=this.initAtDCore(g,f);var h=tinymce.util.Cookie.getHash("atd_ignore");h||(h={}),g.addCommand("mceWritingImprovementTool",function(c){"undefined"!=typeof AtD_proofread_click_count&&AtD_proofread_click_count++,f.editor.setProgressState(1),f._removeWords(),f.sendRequest("checkDocument",d.getContent({format:"raw"}),function(e,g){if(f.editor.setProgressState(0),200!==g.status||"html"===g.responseText.substr(1,4)||!g.responseXML)return void d.windowManager.alert(a("message_server_error","There was a problem communicating with the Proofreading service. Try again in one minute."),c?function(){c(0)}:function(){});if(null!=g.responseXML.getElementsByTagName("message").item(0))return void d.windowManager.alert(g.responseXML.getElementsByTagName("message").item(0).firstChild.data,c?function(){c(0)}:function(){});var h=b.processXML(g.responseXML),i=0;h.count>0&&(i=f.markMyWords(h.errors),d.suggestions=h.suggestions),0!==i||c&&void 0!==c?c&&c(i):d.windowManager.alert(a("message_no_errors_found","No writing errors were found."))})}),g.onInit.add(function(){g.settings.content_css!==!1&&g.dom.loadCSS(g.getParam("atd_css_url",e+"/css/content.css"))}),g.onClick.add(f._showMenu,f),g.onContextMenu.add(f._showMenu,f),g.onPreProcess.add(function(a,b){var d=a.dom;c(d.select("span",b.node).reverse(),function(a){!a||!(d.hasClass(a,"hiddenGrammarError")||d.hasClass(a,"hiddenSpellError")||d.hasClass(a,"hiddenSuggestion")||d.hasClass(a,"mceItemHidden"))&&(d.getAttrib(a,"class")||d.getAttrib(a,"style")||d.getAttrib(a,"id")||d.hasClass(a,"Apple-style-span")||d.getAttrib(a,"mce_name"))||d.remove(a,1)})}),g.onBeforeExecCommand.add(function(a,b){"mceCodeEditor"===b?f._removeWords():"mceFullScreen"===b&&f._done()}),d.addButton("AtD",{title:a("button_proofread_tooltip","Proofread Writing"),image:d.getParam("atd_button_url",e+"/atdbuttontr.gif"),cmd:"mceWritingImprovementTool"})}},_removeWords:function(a){var b=this.editor,c=b.dom,d=b.selection,e=d.getBookmark();b.core.removeWords(void 0,a),c.setHTML(c.getRoot(),c.getRoot().innerHTML),d.moveToBookmark(e)},markMyWords:function(a){var b=this.editor,c=b.selection,d=c.getBookmark(),e=b.core.markMyWords(b.core.contents(this.editor.getBody()),a);return c.moveToBookmark(d),e},_showMenu:function(b,c){var e=this;b=e.editor;var f,g=e._menu,h=b.dom,i=h.getViewPort(b.getWin());if(g||(f=d.getPos(b.getContentAreaContainer()),g=b.controlManager.createDropMenu("spellcheckermenu",{offset_x:f.x,offset_y:f.y,"class":"mceNoIcons"}),e._menu=g),b.core.isMarkedNode(c.target)){g.removeAll();var j=b.core.findSuggestion(c.target);if(j)if(0===j.suggestions.length)g.add({title:j.description,"class":"mceMenuItemTitle"}).setDisabled(1);else{g.add({title:j.description,"class":"mceMenuItemTitle"}).setDisabled(1);for(var k=0;k<j.suggestions.length;k++)!function(a){g.add({title:a,onclick:function(){b.core.applySuggestion(c.target,a),e._checkDone()}})}(j.suggestions[k]);g.addSeparator()}else g.add({title:a("menu_title_no_suggestions","No suggestions"),"class":"mceMenuItemTitle"}).setDisabled(1);return j&&j.moreinfo&&(!function(c){g.add({title:a("menu_option_explain","Explain..."),onclick:function(){b.windowManager.open({url:c,width:480,height:380,inline:!0},{theme_url:this.url})}})}(j.moreinfo),g.addSeparator()),g.add({title:a("menu_option_ignore_once","Ignore suggestion"),onclick:function(){h.remove(c.target,1),e._checkDone()}}),g.add("true"===String(this.editor.getParam("atd_ignore_enable","false"))?{title:a("menu_option_ignore_always","Ignore always"),onclick:function(){var a=e.editor.getParam("atd_ignore_rpc_url","{backend}");if("{backend}"===a){var b=tinymce.util.Cookie.getHash("atd_ignore");b||(b={}),b[c.target.innerHTML]=1,tinymce.util.Cookie.setHash("atd_ignore",b,new Date((new Date).getTime()+15768e7))}else{var d=e.editor.getParam("atd_rpc_id","12345678");tinymce.util.XHR.send({url:a+encodeURI(c.target.innerHTML).replace(/&/g,"%26")+"&key="+d,content_type:"text/xml",async:!0,type:"GET",success:function(){},error:function(a,b,c){alert("Ignore preference save failed\n"+a+"\n"+b.status+"\nAt: "+c.url)}}),e.editor.core.setIgnoreStrings(c.target.innerHTML)}e._removeWords(c.target.innerHTML),e._checkDone()}}:{title:a("menu_option_ignore_all","Ignore all"),onclick:function(){e._removeWords(c.target.innerHTML),e._checkDone()}}),b.selection.select(c.target),f=h.getPos(c.target),g.showMenu(f.x,f.y+c.target.offsetHeight-i.y),tinymce.dom.Event.cancel(c)}g.hideMenu()},_checkDone:function(){var a,b=this,d=b.editor,e=d.dom;c(e.select("span"),function(b){return b&&e.hasClass(b,"mceItemHidden")?(a=!0,!1):void 0}),a||b._done()},_done:function(){var a=this;a._removeWords(),a._menu&&a._menu.hideMenu(),a.editor.nodeChanged()},sendRequest:function(a,b,c){var d=this.editor.getParam("atd_rpc_id","12345678"),e=this.editor.getParam("atd_rpc_url","{backend}"),f=this;return"{backend}"===e||"12345678"===d?(this.editor.setProgressState(0),void alert("Please specify: atd_rpc_url and atd_rpc_id")):void tinymce.util.XHR.send({url:e+"/"+a,content_type:"text/xml",type:"POST",data:"data="+encodeURI(b).replace(/&/g,"%26")+"&key="+d,async:!0,success:c,error:function(a,b,c){f.editor.setProgressState(0),alert(a+"\n"+b.status+"\nAt: "+c.url)}})}}),tinymce.PluginManager.add("AtD",tinymce.plugins.AfterTheDeadlinePlugin)}();