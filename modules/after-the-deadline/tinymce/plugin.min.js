tinymce.PluginManager.add("AtD",function(a){function b(){o=new window.AtDCore,o.map=q,o._isTinyMCE=!0,o.getAttrib=function(a,b){return p.getAttrib(a,b)},o.findSpans=function(a){return void 0===a?p.select("span"):p.select("span",a)},o.hasClass=function(a,b){return p.hasClass(a,b)},o.contents=function(a){return a.childNodes},o.replaceWith=function(a,b){return p.replace(b,a)},o.create=function(a){return p.create("span",{"class":"mceItemHidden","data-mce-bogus":1},a)},o.removeParent=function(a){return p.remove(a,!0),a},o.remove=function(a){p.remove(a)},o.setIgnoreStrings(a.getParam("atd_ignore_strings",[]).join(",")),o.showTypes(a.getParam("atd_show_types",""))}function c(a,b){return window.AtD_l10n_r0ar&&window.AtD_l10n_r0ar[a]||b}function d(a){return a.className&&/\bhidden(GrammarError|SpellError|Suggestion)\b/.test(a.className)}function e(b){return o.markMyWords(o.contents(a.getBody()),b)}function f(){a.dom.select("span.hiddenSpellError, span.hiddenGrammarError, span.hiddenSuggestion").length||(m&&m.hideMenu(),h())}function g(b,c,d){var e=a.dom;d?q(a.dom.select("span.hiddenSpellError, span.hiddenGrammarError, span.hiddenSuggestion"),function(a){var b=a.innerText||a.textContent;b===c&&e.remove(a,!0)}):e.remove(b,!0),f()}function h(){for(var b,c=a.dom,d=new RegExp("mceItemHidden|hidden(((Grammar|Spell)Error)|Suggestion)"),e=c.select("span"),f=e.length;f--;)b=e[f],b.className&&d.test(b.className)&&c.remove(b,!0);a.setContent(a.getContent({format:"raw"}),{format:"raw"}),n=!1,a.nodeChanged(),a.fire("SpellcheckEnd")}function i(b,c,d){var e=a.getParam("atd_rpc_id","12345678"),f=a.getParam("atd_rpc_url","{backend}");return"{backend}"===f||"12345678"===e?void window.alert("Please specify: atd_rpc_url and atd_rpc_id"):(a.setProgressState(!0),void tinymce.util.XHR.send({url:f+"/"+b,content_type:"text/xml",type:"POST",data:"data="+encodeURI(c).replace(/&/g,"%26")+"&key="+e,success:d,error:function(b,c,d){a.setProgressState(),window.alert(b+"\n"+c.status+"\nAt: "+d.url)}}))}function j(){}function k(b){var c=a.getParam("atd_ignore_rpc_url");c&&"{backend}"!==c?tinymce.util.XHR.send({url:c+encodeURIComponent(b)+"&key="+a.getParam("atd_rpc_id","12345678"),content_type:"text/xml",type:"GET",error:function(){j(b)}}):j(b),o.setIgnoreStrings(b)}function l(b){var e,h,i,j=[],l=b.innerText||b.textContent,n=o.findSuggestion(b);n?(j.push({text:n.description,classes:"atd-menu-title",disabled:!0}),n.suggestions.length&&(j.push({text:"-"}),q(n.suggestions,function(a){j.push({text:a,onclick:function(){o.applySuggestion(b,a),f()}})}))):j.push({text:c("menu_title_no_suggestions","No suggestions"),classes:"atd-menu-title",disabled:!0}),n&&n.moreinfo&&(j.push({text:"-"}),j.push({text:c("menu_option_explain","Explain..."),onclick:function(){a.windowManager.open({title:c("menu_option_explain","Explain..."),url:n.moreinfo,width:480,height:380,inline:!0})}})),j.push.apply(j,[{text:"-"},{text:c("menu_option_ignore_once","Ignore suggestion"),onclick:function(){g(b,l)}}]),j.push(a.getParam("atd_ignore_enable")?{text:c("menu_option_ignore_always","Ignore always"),onclick:function(){k(l),g(b,l,!0)}}:{text:c("menu_option_ignore_all","Ignore all"),onclick:function(){g(b,l,!0)}}),m=new tinymce.ui.Menu({items:j,context:"contextmenu",onautohide:function(a){d(a.target)&&a.preventDefault()},onhide:function(){m.remove(),m=null}}),m.renderTo(document.body),e=tinymce.DOM.getPos(a.getContentAreaContainer()),i=a.dom.getPos(b),h=a.dom.getRoot(),"BODY"===h.nodeName?(i.x-=h.ownerDocument.documentElement.scrollLeft||h.scrollLeft,i.y-=h.ownerDocument.documentElement.scrollTop||h.scrollTop):(i.x-=h.scrollLeft,i.y-=h.scrollTop),e.x+=i.x,e.y+=i.y,m.moveTo(e.x,e.y+b.offsetHeight)}var m,n,o,p,q=tinymce.each;a.on("init",function(){"undefined"!=typeof window.AtDCore&&(p=a.dom,b(),a.addCommand("mceWritingImprovementTool",function(b){var d,f=0;return"function"!=typeof b&&(b=function(){}),"undefined"!=typeof window.AtD_proofread_click_count&&window.AtD_proofread_click_count++,n?void h():void i("checkDocument",a.getContent({format:"raw"}),function(g,h){return a.setProgressState(),200===h.status&&"html"!==h.responseText.substr(1,4)&&h.responseXML?null!==h.responseXML.getElementsByTagName("message").item(0)?void a.windowManager.alert(h.responseXML.getElementsByTagName("message").item(0).firstChild.data,b(0)):(d=o.processXML(h.responseXML),d.count>0&&(f=e(d.errors)),f?(n=!0,a.fire("SpellcheckStart")):a.windowManager.alert(c("message_no_errors_found","No writing errors were found.")),void b(f)):void a.windowManager.alert(c("message_server_error","There was a problem communicating with the Proofreading service. Try again in one minute."),b(0))})}),a.settings.content_css!==!1&&p.addStyle(".hiddenSpellError{border-bottom:2px solid red;cursor:default;}.hiddenGrammarError{border-bottom:2px solid green;cursor:default;}.hiddenSuggestion{border-bottom:2px solid blue;cursor:default;}"),tinymce.DOM.addStyle("div.mce-floatpanel{z-index:150100 !important;}"),a.on("click",function(b){d(b.target)&&(b.preventDefault(),a.selection.select(b.target),l(b.target))}))}),a.addMenuItem("spellchecker",{text:c("button_proofread_tooltip","Proofread Writing"),context:"tools",cmd:"mceWritingImprovementTool",onPostRender:function(){var b=this;a.on("SpellcheckStart SpellcheckEnd",function(){b.active(n)})}}),a.addButton("spellchecker",{tooltip:c("button_proofread_tooltip","Proofread Writing"),cmd:"mceWritingImprovementTool",onPostRender:function(){var b=this;a.on("SpellcheckStart SpellcheckEnd",function(){b.active(n)})}}),a.on("remove",function(){m&&(m.remove(),m=null)})});