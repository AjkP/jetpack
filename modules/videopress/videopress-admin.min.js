!function(a){var b=wp.media,c=c||{};c.caps=VideoPressAdminSettings.caps,c.l10n=VideoPressAdminSettings.l10n,b.controller.VideoPress=b.controller.Library.extend({defaults:_.defaults({id:"videopress",router:"videopress",toolbar:"videopress-toolbar",title:"VideoPress",priority:200,searchable:!0,sortable:!1},b.controller.Library.prototype.defaults),initialize:function(){this.get("library")||this.set("library",b.query({videopress:!0})),b.controller.Library.prototype.initialize.apply(this,arguments)},saveContentMode:function(){if("videopress"===this.get("router")){var a=this.frame.content.mode(),b=this.frame.router.get();b&&b.get(a)&&("upload_videopress"===a&&(a="upload"),setUserSetting("libraryContent",a))}}}),b.view.VideoPressUploader=b.View.extend({tagName:"div",className:"uploader-videopress",template:b.template("videopress-uploader"),events:{"submit .videopress-upload-form":"submitForm"},initialize:function(){var a=this;return window.addEventListener?window.addEventListener("message",function(){return a.messageHandler.apply(a,arguments)},!1):window.attachEvent("onmessage",function(){return a.messageHandler.apply(a,arguments)}),b.View.prototype.initialize.apply(this,arguments)},submitForm:function(){var a=!1;return this.clearErrors(),this.$('input[name="videopress_file"]').val().length<1?(this.error(c.l10n.selectVideoFile),!1):(this.$(".videopress-upload-form .button").prop("disabled",!0),b.ajax("videopress-get-upload-token",{async:!1}).done(function(b){a=b,a.success=!0}).fail(function(b){a=b,a.success=!1}),a.success?(this.error(c.l10n.videoUploading,"updated"),this.$('input[name="videopress_blog_id"]').val(a.videopress_blog_id),this.$('input[name="videopress_token"]').val(a.videopress_token),this.$(".videopress-upload-form").attr("action",a.videopress_action_url),!0):(this.$(".videopress-upload-form .button").prop("disabled",!1),this.error(a.message),!1))},error:function(b,c){c=c||"error";var d=a("<div />").html(a("<p />").text(b)).addClass(c);return this.$(".videopress-errors").html(d),this},success:function(a){return this.error(a,"updated")},clearErrors:function(){return this.$(".videopress-errors").html(""),this},messageHandler:function(a){if(a.origin.match(/\.wordpress\.com$/)&&a.data.indexOf&&0===a.data.indexOf("vpUploadResult::")){var d=JSON.parse(a.data.substr(16));if(!d||!d.code)return this.error(c.l10n.unknownError),void this.$(".videopress-upload-form .button").prop("disabled",!1);if("success"==d.code&&d.data){var e=this,f=this.controller,g=f.states.get("videopress");g.set("library",b.query({videopress:!0,vp_random:Math.random()})),g.get("library").more().done(function(){var a=g.get("library").get(d.data.attachment_id);e.clearErrors(),g.get("selection").reset([a]),f.content.mode("browse")})}else this.error(d.code),this.$(".videopress-upload-form .button").prop("disabled",!1)}}});var d=b.model.Attachment.prototype.sync;b.model.Attachment.prototype.sync=function(a,b,c){return b.get("vp_isVideoPress")&&(console.log("syncing "+b.get("vp_guid")),c.data=_.extend(c.data||{},{is_videopress:!0,vp_nonces:b.get("vp_nonces")})),d.apply(this,arguments)};var e=b.view.Attachment.Details;b.view.Attachment.Details=e.extend({initialize:function(){return this.model.get("vp_isVideoPress")&&_.extend(this.events,{"click a.videopress-preview":"vpPreview","change .vp-radio":"vpRadioChange","change .vp-checkbox":"vpCheckboxChange"}),e.prototype.initialize.apply(this,arguments)},render:function(){var a=e.prototype.render.apply(this,arguments);if(this.model.get("vp_isVideoPress")){var c=b.template("videopress-attachment"),d=this.model.toJSON();d.can={},d.can.save=!!d.nonces.update,this.$el.append(c(d))}return a},vpRadioChange:function(b){a(b.target).parents(".vp-setting").find(".vp-radio-text").val(b.target.value).change()},vpCheckboxChange:function(b){a(b.target).parents(".vp-setting").find(".vp-checkbox-text").val(Number(b.target.checked)).change()},vpPreview:function(){return j.render(this),this}});var f=b.view.UploaderWindow;b.view.UploaderWindow=f.extend({show:function(){return"videopress"!=this.controller.state().get("id")&&f.prototype.show.apply(this,arguments),this}});var g=b.view.AttachmentsBrowser;b.view.AttachmentsBrowser=g.extend({createUploader:function(){return"videopress"!=this.controller.state().get("id")?g.prototype.createUploader.apply(this,arguments):void 0}}),_.extend(b.view.MediaFrame.prototype,{VideoPress:{activate:function(){var a=_.first(this.views.get(".media-frame-router")),b={};c.caps.read_videos&&(b.browse={text:c.l10n.VideoPressLibraryRouter,priority:40}),c.caps.upload_videos&&(b.upload_videopress={text:c.l10n.uploadVideoRouter,priority:20}),a.set(b),wp.Uploader.queue.on("add",this.VideoPress.disableUpload,this),this.content.mode("upload"===this.content.mode()&&c.caps.upload_videos?"upload_videopress":"browse")},deactivate:function(){wp.Uploader.queue.off("add",this.VideoPress.disableUpload)},disableUpload:function(a){var b=this.uploader.uploader.uploader;b.stop(),b.splice(),a.destroy()},insert:function(a){var c=a.models[0].get("vp_guid").replace(/[^a-zA-Z0-9]+/,"");return b.editor.insert("[wpvideo "+c+"]"),this},uploadVideo:function(){return this.content.set(new b.view.VideoPressUploader({controller:this})),this},createToolbar:function(){if(this.options.VideoPress&&this.options.VideoPress.hideToolbar)return this;var a=this;this.toolbar.set(new b.view.Toolbar({controller:this,items:{insert:{style:"primary",text:c.l10n.insertVideoButton,priority:80,requires:{library:!0,selection:!0},click:function(){var b=a.state(),c=b.get("selection");a.close(),b.trigger("videopress:insert",c).reset()}}}}))}}});var h={};h.Select=b.view.MediaFrame.Select,b.view.MediaFrame.Select=h.Select.extend({bindHandlers:function(){h.Select.prototype.bindHandlers.apply(this,arguments),this.on("router:create:videopress",this.createRouter,this),this.on("router:activate:videopress",this.VideoPress.activate,this),this.on("router:deactivate:videopress",this.VideoPress.deactivate,this),this.on("content:render:upload_videopress",this.VideoPress.uploadVideo,this),this.on("toolbar:create:videopress-toolbar",this.VideoPress.createToolbar,this),this.on("videopress:insert",this.VideoPress.insert,this)}}),h.Post=b.view.MediaFrame.Post,b.view.MediaFrame.Post=h.Post.extend({createStates:function(){h.Post.prototype.createStates.apply(this,arguments),this.states.add([new b.controller.VideoPress])}});var i=Backbone.View.extend({className:"videopress-modal-container",template:wp.media.template("videopress-media-modal"),render:function(b){return this.delegateEvents({"click .videopress-modal-close":"closeModal","click .videopress-modal-backdrop":"closeModal"}),this.model=b.model,this.guid=this.model.get("vp_guid"),this.$frame||(this.$frame=a(".media-frame-content")),this.$el.html(this.template({video:this.model.get("vp_embed")})),this.$modal=this.$(".videopress-modal"),this.$modal.hide(),this.$frame.append(this.$el),this.$modal.slideDown("fast"),this},closeModal:function(){var a=this;return this.$modal.slideUp("fast",function(){a.remove()}),this}}),j=new i;a(document).on("ready",function(){var b=a("#videopress-settings");if(b.length){var c=b.find('input[name="videopress-access"]'),d=b.find('input[name="videopress-upload"]');c.on("change",function(){var a=c.filter(":checked").val();d.attr("disabled",!a),a||d.attr("checked",!1)}),c.trigger("change")}}),a(document).on("click","#videopress-browse",function(){wp.media({state:"videopress",states:[new b.controller.VideoPress],VideoPress:{hideToolbar:!0}}).open();return!1})}(jQuery);